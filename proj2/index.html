<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CS180 – Project 2 | Mario Gonzalez</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <!-- Navbar -->
  <header class="nav-band">
    <nav class="nav container" aria-label="Primary">
      <a href="../index.html">Home</a>
      <a href="index.html" class="active" aria-current="page">Project 2</a>
    </nav>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="container">
      <h1>Convolution and Filtering</h1>
      <p class="part-note">CS180 • Fall 2025</p>
      <a class="btn" href="../index.html">Back to Home <span class="chev" aria-hidden="true">›</span></a>
    </div>
  </section>

  <!-- ====================== PART 1A ====================== -->
  <section id="part1a" class="section">
    <div class="container">
      <h2 class="section-title">1A – Convolution Filters</h2>

      <p>
        This project studies linear filtering and multi-scale image representations through a sequence of controlled
        experiments. In Part 1, an implemention of a 2-D convolution from first principles is constructed and used to estimate spatial derivatives via
        finite differences, and replace naive differencing with derivative-of-Gaussian (DoG) filters to suppress noise.
        In Part 2, we use filtering as a tool for manipulating frequency content: unsharp masking increases the energy
        of high spatial frequencies to “sharpen” imagery; hybrid images juxtapose low-frequency content from one image
        with high-frequency content from another; and Gaussian/Laplacian stacks enable multi-resolution blending that
        hides seams across scales.
      </p>

      <div class="card" style="padding:16px">
        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:12px">
          <label><strong>Dataset:</strong> <select id="a-dataset"></select></label>

          <strong>k = <span id="a-kval">3</span></strong>
          <input id="a-kIdx" type="range" min="0" max="0" step="1" value="0" style="width:240px" aria-label="kernel size">

          <label><input type="radio" name="a-impl" value="fourloops" checked> From scratch</label>
          <label><input type="radio" name="a-impl" value="scipy"> SciPy</label>
        </div>

        <figure class="media media--narrow" style="margin:0 auto">
          <img id="a-img" alt="1A result">
          <figcaption id="a-cap" style="text-align:center; margin-top:8px"></figcaption>
        </figure>
      </div>

      <p>
        The pedagogical baseline,
        <code>conv2d_four_loops</code>, explicitly flips the kernel and accumulates the product over a zero-padded
        neighborhood using four for loops (two for spatial coordinates and two for kernel indices). The optimized
        variant, <code>conv2d_two_loops</code>, maintains identical semantics but reduces interpreter overhead by
        vectorizing the inner multiply–accumulate across complete row (or column) slices, leaving only two loops
        over output coordinates. For validation and runtime comparison I used <code>conv2d_scipy</code>, a thin wrapper
        around <code>scipy.signal.convolve2d</code> with <em>same</em> output size and <em>fill</em> (zero) boundary
        conditions. The box filter used in this section is created by <code>proj2/filters.box_filter(k)</code>, which
        returns a constant kernel whose entries sum to one, preserving DC gain. Visual and numerical comparisons confirm
        that both custom implementations match SciPy up to floating-point tolerance, while the two-loop version is
        substantially faster than four loops for moderate kernel sizes.
      </p>
    </div>
  </section>

  <!-- ====================== PART 1B ====================== -->
  <section id="part1b" class="section">
    <div class="container">
      <h2 class="section-title">1B – Finite Difference Operator</h2>

      <p>
        To estimate spatial derivatives, I convolve a grayscale image with the forward-difference stencils
        <code>Dx = [-1, 1]</code> and <code>Dy = Dx<sup>T</sup></code> using <code>conv2d_scipy</code>.
        The partials <code>Ix</code> and <code>Iy</code> are then combined into a gradient magnitude image
        <code>|∇I| = sqrt(Ix² + Iy²)</code> (implemented in <code>proj2/edges.py</code>). Binarized “edge maps” are
        obtained by thresholding <code>|∇I|</code> at a fraction of its maximum.
      </p>

      <div class="card" style="padding:16px">
        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:12px">
          <label><input type="radio" name="b-mode" value="Ix" checked> Ix</label>
          <label><input type="radio" name="b-mode" value="Iy"> Iy</label>
          <label><input type="radio" name="b-mode" value="gradmag"> |∇I|</label>
          <label><input type="radio" name="b-mode" value="edges"> Edges</label>

          <span id="b-thr-wrap" style="display:none; gap:10px; align-items:center;">
            <strong>t = <span id="b-tval">10</span></strong>
            <input id="b-tIdx" type="range" min="0" max="4" step="1" value="0" style="width:220px" aria-label="edge threshold">
          </span>
        </div>

        <figure class="media media--narrow" style="margin:0 auto">
          <img id="b-img" alt="1B result">
          <figcaption id="b-cap" style="text-align:center; margin-top:8px"></figcaption>
        </figure>
      </div>
    </div>
  </section>

  <!-- ====================== PART 1C ====================== -->
  <section id="part1c" class="section">
    <div class="container">
      <h2 class="section-title">1C – Derivative of Gaussian (DoG)</h2>

      <div class="card" style="padding:16px">
        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:12px">
          <label><input type="radio" name="c-impl" value="smoothdiff" checked> Smooth → Diff</label>
          <label><input type="radio" name="c-impl" value="DoG"> DoG (∂G ⊗ I)</label>

          <span style="margin-left:12px"></span>

          <label><input type="radio" name="c-mode" value="Ix" checked> Ix</label>
          <label><input type="radio" name="c-mode" value="Iy"> Iy</label>
          <label><input type="radio" name="c-mode" value="gradmag"> |∇I|</label>
        </div>

        <figure class="media media--narrow" style="margin:0 auto">
          <img id="c-img" alt="1C result">
          <figcaption id="c-cap" style="text-align:center; margin-top:8px"></figcaption>
        </figure>
      </div>

      <p>
        I ended up replacing the raw differences with derivatives of a Gaussian. A normalized Gaussian kernel
        <code>G<sub>σ</sub></code> is constructed using
        <code>ksize ≈ 6σ + 1</code> to capture sufficient support. Two pipelines are compared: (i) smoothing the image
        with <code>G<sub>σ</sub></code> and then applying <code>Dx</code>/<code>Dy</code>; and (ii) forming the DoG
        filters <code>∂G/∂x</code>, <code>∂G/∂y</code> (by convolving <code>G</code> with the difference stencils) and
        applying a single convolution per axis. Both methods yield near-identical <code>Ix</code>, <code>Iy</code>, and
        <code>|∇I|</code> when σ and support are matched, but the DoG route is computationally attractive and conceptually
        cleaner.
      </p>
    </div>
  </section>

  <!-- ====================== PART 2A ====================== -->
  <section id="part2a" class="section">
    <div class="container">
      <h2 class="section-title">2A – Unsharp Masking / Sharpening</h2>

      <div class="card" style="padding:16px">
        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:12px">
          <label><strong>Dataset:</strong>
            <select id="ua-dataset">
              <option value="taj" selected>Taj</option>
              <option value="demo">Demo Portrait</option>
            </select>
          </label>

          <label><input type="radio" name="ua-view" value="src" checked> Source</label>
          <label><input type="radio" name="ua-view" value="blur"> Blurred (low-pass)</label>
          <label><input type="radio" name="ua-view" value="high"> High-pass</label>
          <label><input type="radio" name="ua-view" value="sharp"> Sharpened</label>
        </div>

        <figure class="media media--narrow" style="margin:0 auto">
          <img id="ua-img" alt="2A result">
          <figcaption id="ua-cap" style="text-align:center; margin-top:8px"></figcaption>
        </figure>
      </div>

      <p>
        Unsharp masking: <code>blur = G<sub>σ</sub> ⊗ I</code>, <code>high = I − blur</code>, <code>I′ = clip(I + α·high)</code>.
      </p>
    </div>
  </section>

  <!-- ====================== PART 2B ====================== -->
  <section id="part2b" class="section">
    <div class="container">
      <h2 class="section-title">2B – Hybrid Images</h2>

      <div class="card" style="padding:16px">
        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:12px">
          <label><strong>Set:</strong>
            <select id="hy-set">
              <option value="example" selected>Derek and Nutmeg</option>
            </select>
          </label>

          <label><input type="radio" name="hy-view" value="A" checked> Image A</label>
          <label><input type="radio" name="hy-view" value="low"> A: Low-Pass</label>
          <label><input type="radio" name="hy-view" value="B"> Image B</label>
          <label><input type="radio" name="hy-view" value="high"> High-pass(B)</label>
          <label><input type="radio" name="hy-view" value="hybrid"> Hybrid</label>
        </div>

        <figure class="media media--narrow" style="margin:0 auto">
          <img id="hy-img" alt="2B result">
          <figcaption id="hy-cap" style="text-align:center; margin-top:8px"></figcaption>
        </figure>
      </div>
    </div>
  </section>

  <!-- ====================== PART 2C ====================== -->
  <section id="part2c" class="section">
    <div class="container">
      <h2 class="section-title">2C – Gaussian & Laplacian Stacks</h2>

      <div class="card" style="padding:16px">
        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:12px">
          <label><strong>Image:</strong>
            <select id="st-img">
              <option value="apple" selected>Apple</option>
              <option value="orange">Orange</option>
            </select>
          </label>

          <label><input type="radio" name="st-type" value="gauss" checked> Gaussian Stack</label>
          <label><input type="radio" name="st-type" value="lap"> Laplacian Stack</label>
        </div>

        <figure class="media media--narrow" style="margin:0 auto">
          <img id="st-view" alt="2C result">
          <figcaption id="st-cap" style="text-align:center; margin-top:8px"></figcaption>
        </figure>
      </div>
    </div>
  </section>

  <!-- ====================== PART 2D ====================== -->
  <section id="part2d" class="section">
    <div class="container">
      <h2 class="section-title">2D – Multiresolution Blending</h2>

      <div class="card" style="padding:16px">
        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:12px">
          <label><strong>Mask:</strong>
            <select id="blend-mask">
              <option value="vertical" selected>Vertical</option>
              <option value="irregular">Irregular</option>
            </select>
          </label>

          <label><input type="radio" name="blend-view" value="result" checked> Result</label>
          <label><input type="radio" name="blend-view" value="mask_stack"> Mask Stack</label>
          <label><input type="radio" name="blend-view" value="lap_blended"> Laplacian Blended Stack</label>
        </div>

        <figure class="media media--narrow" style="margin:0 auto">
          <img id="blend-img" alt="2D result">
          <figcaption id="blend-cap" style="text-align:center; margin-top:8px"></figcaption>
        </figure>
      </div>

  

  <!-- ====================== Shared JS helpers ====================== -->
  <script>
  (function(){
    const EXTS = ['png','jpg','jpeg'];
    const $ = s => document.querySelector(s);

    function tryLoad(imgEl, paths, i=0){
      if(i >= paths.length){ imgEl.removeAttribute('src'); return; }
      imgEl.onerror = () => tryLoad(imgEl, paths, i+1);
      imgEl.src = paths[i];
    }
    function onRadios(name, cb){
      document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.addEventListener('change', cb));
    }
    window.UI = {EXTS, $, tryLoad, onRadios};
  })();
  </script>

  <!-- ====================== 1A viewer ====================== -->
  <script>
  (function () {
    const {EXTS, $, tryLoad, onRadios} = UI;
    const CONFIG = {
      base: 'media/part1',
      datasets: [{ id: 'box', label: 'Box Filter', ks: [3,5,9,15] }]
    };

    const dsSel = $('#a-dataset'), kIdx = $('#a-kIdx'), kval = $('#a-kval'),
          img = $('#a-img'), cap = $('#a-cap');

    CONFIG.datasets.forEach(d => {
      const o = document.createElement('option'); o.value = d.id; o.textContent = d.label;
      dsSel.appendChild(o);
    });

    const curDS = () => CONFIG.datasets.find(d => d.id === dsSel.value);
    const curImpl = () => document.querySelector('input[name="a-impl"]:checked').value;

    function setSlider(ds){
      kIdx.min = 0; kIdx.max = ds.ks.length - 1;
      if(+kIdx.value > +kIdx.max) kIdx.value = 0;
    }

    function update(){
      const ds = curDS(), k = ds.ks[+kIdx.value], impl = curImpl();
      kval.textContent = k;
      cap.textContent = `${ds.label} — ${impl==='fourloops'?'From scratch':'SciPy'} (k=${k})`;
      const paths = EXTS.map(ext => `${CONFIG.base}/${ds.id}/${ds.id}_${impl}_k${k}.${ext}`);
      tryLoad(img, paths);
    }

    dsSel.addEventListener('change', () => { setSlider(curDS()); update(); });
    kIdx.addEventListener('input', update);
    onRadios('a-impl', update);

    setSlider(curDS()); update();
  })();
  </script>

  <!-- ====================== 1B viewer ====================== -->
  <script>
  (function () {
    const {EXTS, $, tryLoad, onRadios} = UI;
    const BASE = 'media/part1_2';
    const THRESH = [10,15,20,25,30];

    const mode = () => document.querySelector('input[name="b-mode"]:checked').value;
    const tIdx = $('#b-tIdx'), tVal = $('#b-tval'), thrWrap = $('#b-thr-wrap'),
          img = $('#b-img'), cap = $('#b-cap');

    function candidates(){
      const m = mode();
      if(m==='edges'){
        const t = THRESH[+tIdx.value];
        tVal.textContent = t;
        return EXTS.map(ext => `${BASE}/p1_2_edges_t${t}.${ext}`);
      }
      const file = m==='Ix' ? 'p1_2_Ix' : m==='Iy' ? 'p1_2_Iy' : 'p1_2_gradmag';
      return EXTS.map(ext => `${BASE}/${file}.${ext}`);
    }

    function update(){
      thrWrap.style.display = (mode()==='edges') ? 'inline-flex' : 'none';
      const label = (mode()==='gradmag') ? '|∇I|' : mode();
      cap.textContent = `Finite difference — ${label}` + (mode()==='edges' ? ` (t=${THRESH[+tIdx.value]})` : '');
      tryLoad(img, candidates());
    }

    onRadios('b-mode', update);
    tIdx.addEventListener('input', update);
    update();
  })();
  </script>

  <!-- ====================== 1C viewer ====================== -->
  <script>
  (function () {
    const {EXTS, $, tryLoad, onRadios} = UI;
    const BASE = 'media/part1_3';

    const impl = () => document.querySelector('input[name="c-impl"]:checked').value;
    const mode = () => document.querySelector('input[name="c-mode"]:checked').value;
    const img  = $('#c-img'), cap = $('#c-cap');

    function update() {
      const m = mode();
      const i = impl() === 'smoothdiff' ? 'Smooth → Diff' : 'DoG';
      cap.textContent = `1C — ${i}, ${m === 'gradmag' ? '|∇I|' : m}`;
      const file = `p1_3_${m}_${impl()}`;
      tryLoad(img, EXTS.map(ext => `${BASE}/${file}.${ext}`));
    }

    onRadios('c-impl', update);
    onRadios('c-mode', update);
    update();
  })();
  </script>

  <!-- ====================== Config for Part 2D datasets ====================== -->
  <script id="blend-config" type="application/json">
  {
    "base": "media/part2_4",
    "exts": ["png","jpg","jpeg"],
    "datasets": [
      {
        "id": "oraple",
        "label": "Oraple ",
        "stems": {
          "result": "{id}_{mask}",
          "mask_stack": "mask_stack_{mask}",
          "lap_blended": "lap_blended_{mask}"
        }
      },
      {
        "id": "sbrainer",
        "label": "Santa Barbara ⊕ Rainer (irregular mask)",
        "stems": {
          "result": "sbrainer",
          "mask_stack": "stacks_rainer_sb_rainer_mask_L10_k17_s8.0_f65_lin_Gmask_grid",
          "lap_blended": "stacks_rainer_sb_rainer_mask_L10_k17_s8.0_f65_lin_Ls_grid"
        }
      },
      {

      "id": "bell_clouds",
      "label": "Campanile ⊕ Nighttime Clouds",
      "stems": {
        "result": "bell_clouds",
        "mask_stack": "stacks_clouds_bell_night_cloud_mask_L6_k17_s16.0_f65_lin_Gmask_grid",
        "lap_blended": "stacks_clouds_bell_night_cloud_mask_L6_k17_s16.0_f65_lin_Ls_grid"
      }
    }
    ]
  }
  </script>

  <!-- === Single driver for ALL Part 2 viewers (2A/2B/2C/2D) === -->
  <script>
  (function(){
    const EXTS = (window.UI && UI.EXTS) || ['png','jpg','jpeg'];
    const $    = (window.UI && UI.$)    || (s => document.querySelector(s));
    const tryLoad = (window.UI && UI.tryLoad) || function(imgEl, paths, i=0){
      if(i>=paths.length){ imgEl.removeAttribute('src'); return; }
      imgEl.onerror = () => tryLoad(imgEl, paths, i+1);
      imgEl.src = paths[i];
    };

    function makePart2Viewer({base, imgSel, capSel, watch, resolve, exts=EXTS}) {
      const img = $(imgSel), cap = $(capSel);

      function readState() {
        const s = {};
        for (const w of watch) {
          if (w.kind === 'radio') {
            const el = document.querySelector(`input[name="${w.name}"]:checked`);
            s[w.as] = el ? el.value : undefined;
          } else if (w.kind === 'select') {
            const el = document.getElementById(w.id);
            s[w.as] = el ? el.value : undefined;
          }
        }
        return s;
      }

      function update() {
        const state = readState();
        const { stem, stems, label } = resolve(state) || {};
        const list = stems || (stem ? [stem] : []);
        if (label) cap.textContent = label;
        if (!list.length) { img.removeAttribute('src'); return; }
        const paths = [];
        for (const s of list) for (const ext of exts) paths.push(`${base}/${s}.${ext}`);
        tryLoad(img, paths);
      }

      for (const w of watch) {
        if (w.kind === 'radio') {
          document.querySelectorAll(`input[name="${w.name}"]`).forEach(r => r.addEventListener('change', update));
        } else if (w.kind === 'select') {
          const el = document.getElementById(w.id);
          if (el) el.addEventListener('change', update);
        }
      }
      update();
      return update;
    }

    // ---------- 2A ----------
    makePart2Viewer({
      base: 'media/part2_1',
      imgSel: '#ua-img',
      capSel: '#ua-cap',
      watch: [
        {kind:'select', id:'ua-dataset', as:'ds'},
        {kind:'radio',  name:'ua-view',  as:'view'}
      ],
      resolve: ({ds, view}) => {
        const nice = {src:'Source', blur:'Blurred (LPF)', high:'High-pass', sharp:'Sharpened'}[view] || view;
        const stemBy = {
          taj:  {src:'taj', blur:'taj_blur', high:'taj_high', sharp:'taj_sharp'},
          demo: {src:'demo_src', blur:'demo_src_blurred', high:'taj_high', sharp:'demo_src_resharp'}
        };
        const stem = stemBy[ds]?.[view] || null;
        return { stem, label: `2A — ${ds==='taj'?'Taj':'Demo'} • ${nice}` };
      }
    });

    // ---------- 2B ----------
    makePart2Viewer({
      base: 'media/part2_2',
      imgSel: '#hy-img',
      capSel: '#hy-cap',
      watch: [
        {kind:'select', id:'hy-set',   as:'set'},
        {kind:'radio',  name:'hy-view',as:'view'}
      ],
      resolve: ({set, view}) => {
        const names = {A:'A (low-freq carrier)', low:'Low-pass(A)', B:'B (high-freq detail)', high:'High-pass(B)', hybrid:'Hybrid'};
        return { stem: view, label: `2B — ${set==='example'?'Example':set} • ${names[view]||view}` };
      }
    });

    // ---------- 2C ----------
    makePart2Viewer({
      base: 'media/part2_3',
      imgSel: '#st-view',
      capSel: '#st-cap',
      watch: [
        {kind:'select', id:'st-img',    as:'img'},
        {kind:'radio',  name:'st-type', as:'type'}
      ],
      resolve: ({img, type}) => {
        const name = img==='apple' ? 'Apple' : 'Orange';
        return { stem: `${type}_${img}`, label: `2C — ${type==='gauss'?'Gaussian':'Laplacian'} stack • ${name}` };
      }
    });

    // ---------- 2D ----------
    makePart2Viewer({
      base: (function(){
        const el = document.querySelector('#blend-config');
        if (!el) return 'media/part2_4';
        try { return JSON.parse(el.textContent).base || 'media/part2_4'; }
        catch (_) { return 'media/part2_4'; }
      })(),
      imgSel: '#blend-img',
      capSel: '#blend-cap',
      watch: [
        {kind:'select', id:'blend-ds',  as:'ds'},
        {kind:'select', id:'blend-mask',as:'mask'},
        {kind:'radio',  name:'blend-view', as:'view'}
      ],
      resolve: ({ds, mask, view}) => {
        const el = document.querySelector('#blend-config');
        let CFG = null;
        if (el) { try { CFG = JSON.parse(el.textContent); } catch(_){} }
        const datasets = CFG?.datasets || [{id:'oraple', label:'Oraple', stems:{
          result:'{id}_{mask}', mask_stack:'mask_stack_{mask}', lap_blended:'lap_blended_{mask}'
        }}];

        // Ensure a dataset selector exists; create if missing
        let dsSel = document.querySelector('#blend-ds');
        if (!dsSel) {
          const controls = document.querySelector('#blend-mask').closest('div');
          const lab = document.createElement('label');
          lab.innerHTML = '<strong>Pair:</strong> <select id="blend-ds"></select>';
          controls.insertBefore(lab, controls.firstChild);
          dsSel = lab.querySelector('select');
          dsSel.innerHTML = datasets.map(d=>`<option value="${d.id}">${d.label||d.id}</option>`).join('');
          dsSel.addEventListener('change', () => document.querySelector('input[name="blend-view"]:checked').dispatchEvent(new Event('change')));
        }

        const active = datasets.find(d => d.id === (ds || dsSel.value)) || datasets[0];
        if (dsSel && dsSel.value !== active.id) dsSel.value = active.id;

        const tpl = active.stems?.[view];
        const rel = tpl ? tpl.replace(/\{(\w+)\}/g, (_,k)=>({id:active.id,mask}[k]??'')) : `${active.id}_${mask}`;
        const vname = view==='result' ? 'Result' : (view==='mask_stack' ? 'Mask stack' : 'Laplacian blended stack');
        const mname = mask==='vertical' ? 'vertical' : 'Irregular';
        return { stem: rel, label: `${active.label||active.id}` };
      }
    });

  })();
  </script>
</body>
</html>
